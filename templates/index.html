<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasa Wire Label Printer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>üè∑Ô∏è Kasa Wire Label Printer</h1>
        
        <!-- Profile and Settings Section -->
        <div class="settings-section">
            <div class="profile-row">
                <div class="profile-group">
                    <form method="POST" action="/select_profile" class="profile-form">
                        <label for="profile_select" class="profile-label">üè∑Ô∏è Label Profile:</label>
                        <select id="profile_select" name="profile_name" class="profile-select" onchange="this.form.submit()">
                            {% for profile_name in profiles.keys() %}
                            <option value="{{ profile_name }}" {% if profile_name == current_profile %}selected{% endif %}>
                                {{ profile_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <a href="/settings" class="settings-link" id="settingsLink">‚öôÔ∏è Settings</a>
                    </form>
                </div>
            </div>
            
            <!-- Printer Section -->
            {% if printer_info.available %}
            <div class="profile-row">
                <div class="profile-group">
                    <form method="POST" action="/select_printer" class="profile-form">
                        <label for="printer_select" class="profile-label">üñ®Ô∏è Printer:</label>
                        <select id="printer_select" name="printer_name" class="profile-select" onchange="this.form.submit()">
                            <option value="">No printer selected</option>
                            {% for printer in printer_info.printers %}
                            <option value="{{ printer }}" {% if printer == settings.selected_printer %}selected{% endif %}>
                                {{ printer }}{% if printer == printer_info.default %} (Default){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            </div>
            {% endif %}
            
            <!-- Current Profile Info -->
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                <strong>Current Profile:</strong> {{ current_profile }} - {{ "%.3f"|format(settings.width_inches) }}" wide, {{ settings.lines_per_label }} lines, {{ settings.labels_per_row }} per row, 
                Font: {{ settings.font_name }} {{ 'Bold' if settings.font_bold else '' }} {{ settings.font_size }}pt{{ ', Autosize Font: Yes' if settings.auto_size_font else '' }}
                {% if printer_info.available and settings.selected_printer %}
                <br><strong>Printer:</strong> {{ settings.selected_printer }} - Status: Ready
                {% endif %}
            </div>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <form id="labelForm" method="POST">
            <!-- Add Wire IDs Section -->
            <div class="settings-section">
                <h2>Add Wire IDs</h2>
                <div class="add-wire-row">
                    <div class="form-group">
                        <label for="wireIdInput">Wire ID *</label>
                        <input type="text" id="wireIdInput" placeholder="e.g., PWR-001" required>
                    </div>
                    <div class="form-group">
                        <label for="qtyInput">Quantity *</label>
                        <input type="number" id="qtyInput" value="1" min="1" max="999" required>
                    </div>
                    <div class="button-group">
                        <button type="button" id="addWireIdBtn" class="btn btn-success">‚úÖ Add</button>
                        <button type="button" id="decimalSeqBtn" class="btn btn-primary">üî¢ Decimal Sequence</button>
                    </div>
                </div>
                <div class="help-text" style="font-size: 14px; color: #666; margin-top: 10px;">
                    Enter a Wire ID and quantity, then click Add or press Enter. The quantity will be remembered for the next entry.
                </div>
            </div>
            
            <!-- Wire ID List Section -->
            <div class="settings-section">
                <div class="wire-list-header">
                    <h2>Wire ID List</h2>
                    <div class="wire-list-actions">
                        <button type="button" id="sortBtn" class="btn btn-secondary">üìä Sort A-Z</button>
                        <button type="button" id="clearAllBtn" class="btn btn-danger">üóëÔ∏è Clear All</button>
                    </div>
                </div>
                
                <table class="wire-table" id="wireIdTable">
                    <thead>
                        <tr>
                            <th>Wire ID</th>
                            <th style="width: 100px; text-align: center;">Quantity</th>
                            <th style="width: 80px; text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="wireIdTableBody">
                        <tr class="empty-row">
                            <td colspan="3" style="text-align: center; color: #999; font-style: italic; padding: 30px;">
                                No Wire IDs added yet. Use the form above to add Wire IDs.
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="table-summary" id="tableSummary" style="display: none; margin-top: 10px;">
                    <strong>Summary:</strong> <span id="summaryText">0 Wire IDs, 0 total labels</span>
                </div>
            </div>
            
            <!-- Hidden textarea for form submission -->
            <textarea id="wire_ids" name="wire_ids" style="display: none;"></textarea>
            
            <!-- Action Buttons -->
            <div class="button-group">                
                {# <button type="button" id="generateBtn" class="btn btn-primary">
                    üìÑ Export PDF
                </button> #}
                <button type="button" id="exportBtn" class="btn btn-secondary">
                    üìä Export CSV
                </button>
                {% if printer_info.available and settings.selected_printer %}
                <button type="button" id="printBtn" class="btn btn-success">
                    üñ®Ô∏è Print to <span style="font-weight: bold;">{{ settings.selected_printer[:30] }}{{ '...' if settings.selected_printer|length > 30 else '' }}</span>
                </button>
                {% endif %}
            </div>
        </form>
        
        <!-- Import Section -->
        <div class="import-section">
            <h3 style="margin-top: 0; margin-bottom: 15px; color: #495057;">üìÅ Import Wire IDs</h3>
            <div class="button-group">
                <button type="button" id="importCSVBtn" class="btn btn-primary">üìÑ Import CSV</button>
                <button type="button" id="importLegacyBtn" class="btn btn-secondary">üìú Import Legacy</button>
            </div>
            
            <!-- Hidden file inputs -->
            <form id="importForm" method="POST" enctype="multipart/form-data" action="/import_csv" style="display: none;">
                <input type="file" id="csvFileInput" name="csv_file" accept=".csv">
            </form>
            
            <form id="importLegacyForm" method="POST" enctype="multipart/form-data" action="/import_legacy" style="display: none;">
                <input type="file" id="legacyFileInput" name="legacy_file" accept=".lbl">
            </form>
            
            <div class="help-text" style="margin-top: 10px; font-size: 12px;">
                <strong>CSV:</strong> Import previously exported files | <strong>Legacy:</strong> Import old format files
            </div>
        </div>
    </div>
    
    <!-- Decimal Sequence Modal -->
    <div id="decimalSequenceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Generate Decimal Sequence</h3>
                <button type="button" class="close-btn" onclick="closeDecimalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalPrefix">Prefix:</label>
                        <input type="text" id="modalPrefix" placeholder="e.g., WIRE" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modalSuffix">Suffix:</label>
                        <input type="text" id="modalSuffix" placeholder="e.g., -A" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalStart">Start:</label>
                        <input type="number" id="modalStart" value="1" min="0" step="0.001" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modalStop">Stop:</label>
                        <input type="number" id="modalStop" value="10" min="0" step="0.001" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modalIncrement">Increment by:</label>
                        <input type="number" id="modalIncrement" value="1" min="0.001" step="0.001" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalQtyEach">Qty Each:</label>
                        <input type="number" id="modalQtyEach" value="1" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>                    
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label for="modalZeroPadding">Zero Padding (digits):</label>
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="modalLeadingZeros" style="margin-right: 8px;">
                                <label for="modalLeadingZeros" style="margin: 0; cursor: pointer; font-size: 14px;">Leading Zeros</label>
                            </div>
                        </div>
                        <input type="number" id="modalZeroPadding" value="3" min="1" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #6c757d; font-size: 12px;">Number of digits for leading zeros (e.g., 3 = 001, 002, ...)</small>
                    </div>
                </div>
                                
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #495057;">Preview:</div>
                    <div id="sequencePreview" style="font-family: monospace; color: #6c757d; font-size: 13px; line-height: 1.4;">
                        Enter values to see preview
                    </div>
                    <div id="sequenceCount" style="margin-top: 8px; font-size: 12px; color: #6c757d; font-weight: 500;">
                        Total items: 0
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDecimalModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmDecimalSequence()">Generate Sequence</button>
            </div>
        </div>
    </div>

    <script>
        // Wire ID management
        let wireIdList = [];
        
        // Load existing wire IDs from the hidden textarea if any
        function loadExistingWireIds() {
            const existingData = {{ (wire_ids if wire_ids else "")|tojson }};
            console.log('Loading existing wire IDs:', existingData);
            
            if (existingData && existingData.trim()) {
                const lines = existingData.split('\n');
                console.log('Lines to process:', lines);
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    
                    if (line.includes(',')) {
                        const parts = line.split(',');
                        const wireId = parts[0].trim();
                        const quantity = parseInt(parts[1]) || 1;
                        
                        if (wireId) {
                            wireIdList.push({ wireId: wireId, quantity: quantity });
                        }
                    } else {
                        wireIdList.push({ wireId: line, quantity: 1 });
                    }
                });
                
                updateTable();
                console.log('Loaded wire IDs:', wireIdList);
            }
        }
        
        // Add wire ID to the list
        function addWireId() {
            const wireIdInput = document.getElementById('wireIdInput');
            const qtyInput = document.getElementById('qtyInput');
            
            const wireId = wireIdInput.value.trim().toUpperCase();
            const quantity = parseInt(qtyInput.value) || 1;
            
            if (!wireId) {
                alert('Please enter a Wire ID');
                wireIdInput.focus();
                return;
            }
            
            // Check for duplicates
            const existing = wireIdList.find(item => item.wireId === wireId);
            if (existing) {
                if (confirm(`Wire ID "${wireId}" already exists with quantity ${existing.quantity}. Add ${quantity} more (total will be ${existing.quantity + quantity})?`)) {
                    existing.quantity += quantity;
                } else {
                    wireIdInput.focus();
                    return;
                }
            } else {
                wireIdList.push({ wireId: wireId, quantity: quantity });
            }
            
            wireIdInput.value = '';
            wireIdInput.focus();
            
            updateTable();
            updateHiddenTextarea();
        }
        
        // Generate decimal sequence
        function generateDecimalSequence() {
            const wireIdInput = document.getElementById('wireIdInput');
            const qtyInput = document.getElementById('qtyInput');
            
            // Pre-fill modal with current form values
            const currentWireId = wireIdInput.value.trim().toUpperCase();
            
            // Try to separate prefix and number from current Wire ID
            if (currentWireId) {
                const match = currentWireId.match(/^([A-Za-z]*)(\d*)([A-Za-z]*)$/);
                if (match) {
                    document.getElementById('modalPrefix').value = match[1] || currentWireId;
                    if (match[2]) {
                        document.getElementById('modalStart').value = match[2];
                        document.getElementById('modalStop').value = parseInt(match[2]) + 9;
                    }
                    document.getElementById('modalSuffix').value = match[3] || '';
                } else {
                    document.getElementById('modalPrefix').value = currentWireId;
                }
            }
            
            document.getElementById('modalQtyEach').value = qtyInput.value || '1';
            
            // Show modal
            document.getElementById('decimalSequenceModal').style.display = 'block';
            
            // Focus on prefix input
            setTimeout(() => {
                document.getElementById('modalPrefix').focus();
            }, 100);
            
            updateSequencePreview();
        }
        
        // Update sequence preview
        function updateSequencePreview() {
            const prefix = document.getElementById('modalPrefix').value.trim();
            const suffix = document.getElementById('modalSuffix').value.trim();
            const start = parseFloat(document.getElementById('modalStart').value) || 0;
            const stop = parseFloat(document.getElementById('modalStop').value) || 0;
            const increment = parseFloat(document.getElementById('modalIncrement').value) || 1;
            const qtyEach = parseInt(document.getElementById('modalQtyEach').value) || 1;
            const leadingZeros = document.getElementById('modalLeadingZeros').checked;
            const zeroPadding = parseInt(document.getElementById('modalZeroPadding').value) || 3;
            
            console.log('Preview - leadingZeros:', leadingZeros, 'zeroPadding:', zeroPadding); // Debug log
            
            const previewElement = document.getElementById('sequencePreview');
            const countElement = document.getElementById('sequenceCount');
            
            // Validation
            if (start > stop) {
                previewElement.textContent = 'Start must be less than or equal to Stop';
                countElement.textContent = 'Total items: 0';
                return;
            }
            
            if (increment <= 0) {
                previewElement.textContent = 'Increment must be greater than 0';
                countElement.textContent = 'Total items: 0';
                return;
            }
            
            // Calculate sequence (handle decimal increments with precision)
            const numbers = [];
            let current = start;
            
            // Continue while the integer part of current is <= stop, or current <= stop for whole numbers
            while (Math.floor(current) <= Math.floor(stop) || (increment >= 1 && current <= stop)) {
                // Use precise decimal arithmetic to avoid floating-point errors
                const value = Math.round(current * 1000) / 1000;
                
                // For decimal increments, include all values where integer part <= stop
                // For whole number increments, use normal <= comparison
                if (increment < 1 ? Math.floor(value) <= Math.floor(stop) : value <= stop) {
                    numbers.push(value);
                }
                
                current += increment;
                
                // Safety break to prevent infinite loops
                if (numbers.length > 10000) break;
            }
            
            if (numbers.length === 0) {
                previewElement.textContent = 'No numbers in range';
                countElement.textContent = 'Total items: 0';
                return;
            }
            
            // Generate preview
            let preview = '';
            const showCount = Math.min(numbers.length, 5);
            
            for (let i = 0; i < showCount; i++) {
                const num = numbers[i];
                // Format number: preserve .0 for decimal increments, remove unnecessary trailing zeros for others
                let formattedNum;
                if (increment < 1 && num % 1 === 0) {
                    // For decimal increments, preserve .0 (e.g., 1.0, 2.0)
                    formattedNum = num.toFixed(1);
                } else if (num % 1 === 0) {
                    // For whole numbers with whole increments, just use integer
                    formattedNum = num.toString();
                } else {
                    // For actual decimals, remove trailing zeros but keep significant digits
                    formattedNum = num.toFixed(3).replace(/\.?0+$/, '');
                }
                
                // Apply leading zeros only to whole numbers (including x.0 from decimal sequences)
                if (leadingZeros && num % 1 === 0) {
                    if (increment < 1 && num % 1 === 0) {
                        // For decimal sequences like 1.0, 2.0, pad the integer part but keep .0
                        const integerPart = Math.floor(num).toString().padStart(zeroPadding, '0');
                        formattedNum = integerPart + '.0';
                    } else {
                        // For whole number sequences, pad normally
                        formattedNum = formattedNum.padStart(zeroPadding, '0');
                    }
                }
                
                const wireId = prefix + formattedNum + suffix;
                
                if (i > 0) preview += '\n';
                
                if (qtyEach === 1) {
                    preview += wireId;
                } else {
                    preview += `${wireId} (qty: ${qtyEach})`;
                }
            }
            
            if (numbers.length > 5) {
                preview += `\n... and ${numbers.length - 5} more`;
            }
            
            previewElement.textContent = preview;
            
            // Calculate total items
            const totalUniqueIds = numbers.length;
            const totalLabels = totalUniqueIds * qtyEach;
            countElement.textContent = `Total items: ${totalUniqueIds} unique IDs, ${totalLabels} total labels`;
        }
        
        // Close decimal modal
        function closeDecimalModal() {
            document.getElementById('decimalSequenceModal').style.display = 'none';
        }
        
        // Confirm decimal sequence generation
        function confirmDecimalSequence() {
            const prefix = document.getElementById('modalPrefix').value.trim();
            const suffix = document.getElementById('modalSuffix').value.trim();
            const start = parseFloat(document.getElementById('modalStart').value);
            const stop = parseFloat(document.getElementById('modalStop').value);
            const increment = parseFloat(document.getElementById('modalIncrement').value) || 1;
            const qtyEach = parseInt(document.getElementById('modalQtyEach').value) || 1;
            const leadingZeros = document.getElementById('modalLeadingZeros').checked;
            const zeroPadding = parseInt(document.getElementById('modalZeroPadding').value) || 3;
            
            // Validation
            if (isNaN(start) || isNaN(stop)) {
                alert('Please enter valid Start and Stop numbers');
                return;
            }
            
            if (start > stop) {
                alert('Start must be less than or equal to Stop');
                return;
            }
            
            if (increment <= 0) {
                alert('Increment must be greater than 0');
                return;
            }
            
            if (qtyEach <= 0) {
                alert('Quantity Each must be greater than 0');
                return;
            }
            
            // Calculate sequence (handle decimal increments with precision)
            const numbers = [];
            let current = start;
            
            // Continue while the integer part of current is <= stop, or current <= stop for whole numbers
            while (Math.floor(current) <= Math.floor(stop) || (increment >= 1 && current <= stop)) {
                // Use precise decimal arithmetic to avoid floating-point errors
                const value = Math.round(current * 1000) / 1000;
                
                // For decimal increments, include all values where integer part <= stop
                // For whole number increments, use normal <= comparison
                if (increment < 1 ? Math.floor(value) <= Math.floor(stop) : value <= stop) {
                    numbers.push(value);
                }
                
                current += increment;
                
                // Safety break to prevent infinite loops
                if (numbers.length > 10000) break;
            }
            
            if (numbers.length === 0) {
                alert('No numbers in the specified range');
                return;
            }
            
            // Confirm generation
            const totalUniqueIds = numbers.length;
            const totalLabels = totalUniqueIds * qtyEach;
            
            if (!confirm(`Generate ${totalUniqueIds} unique Wire IDs (${totalLabels} total labels)?`)) {
                return;
            }
            
            // Generate the sequence
            let addedCount = 0;
            numbers.forEach(num => {
                // Format number: preserve .0 for decimal increments, remove unnecessary trailing zeros for others
                let formattedNum;
                if (increment < 1 && num % 1 === 0) {
                    // For decimal increments, preserve .0 (e.g., 1.0, 2.0)
                    formattedNum = num.toFixed(1);
                } else if (num % 1 === 0) {
                    // For whole numbers with whole increments, just use integer
                    formattedNum = num.toString();
                } else {
                    // For actual decimals, remove trailing zeros but keep significant digits
                    formattedNum = num.toFixed(3).replace(/\.?0+$/, '');
                }
                
                // Apply leading zeros only to whole numbers (including x.0 from decimal sequences)
                if (leadingZeros && num % 1 === 0) {
                    if (increment < 1 && num % 1 === 0) {
                        // For decimal sequences like 1.0, 2.0, pad the integer part but keep .0
                        const integerPart = Math.floor(num).toString().padStart(zeroPadding, '0');
                        formattedNum = integerPart + '.0';
                    } else {
                        // For whole number sequences, pad normally
                        formattedNum = formattedNum.padStart(zeroPadding, '0');
                    }
                }
                
                const wireId = prefix + formattedNum + suffix;
                
                // Check for duplicates
                const existing = wireIdList.find(item => item.wireId === wireId);
                if (existing) {
                    // Add to existing quantity
                    existing.quantity += qtyEach;
                } else {
                    // Add new wire ID
                    wireIdList.push({ wireId: wireId, quantity: qtyEach });
                    addedCount++;
                }
            });
            
            // Update display
            updateTable();
            updateHiddenTextarea();
            
            // Close modal
            closeDecimalModal();
            
            // Clear original form
            document.getElementById('wireIdInput').value = '';
            document.getElementById('qtyInput').value = '1';
            document.getElementById('wireIdInput').focus();
            
            // Show success message
            if (addedCount > 0) {
                alert(`Successfully added ${addedCount} new Wire IDs to the list!`);
            } else {
                alert('All Wire IDs already existed. Quantities have been updated.');
            }
        }
        
        // Remove wire ID from the list
        function removeWireId(index) {
            if (confirm(`Remove "${wireIdList[index].wireId}" from the list?`)) {
                wireIdList.splice(index, 1);
                updateTable();
                updateHiddenTextarea();
            }
        }
        
        // Update the table display
        function updateTable() {
            const tbody = document.getElementById('wireIdTableBody');
            tbody.innerHTML = '';
            
            if (wireIdList.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="3" style="text-align: center; color: #999; font-style: italic; padding: 30px;">
                            No Wire IDs added yet. Use the form above to add Wire IDs.
                        </td>
                    </tr>
                `;
                document.getElementById('tableSummary').style.display = 'none';
            } else {
                wireIdList.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 8px;"><strong>${item.wireId}</strong></td>
                        <td style="padding: 8px; text-align: center;">${item.quantity}</td>
                        <td style="padding: 8px; text-align: center;">
                            <button type="button" class="btn-danger" onclick="removeWireId(${index})" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update summary
                const totalLabels = wireIdList.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById('summaryText').textContent = 
                    `${wireIdList.length} Wire ID${wireIdList.length !== 1 ? 's' : ''}, ${totalLabels} total labels`;
                document.getElementById('tableSummary').style.display = 'block';
            }
        }
        
        // Update hidden textarea for form submission
        function updateHiddenTextarea() {
            const textarea = document.getElementById('wire_ids');
            const lines = wireIdList.map(item => `${item.wireId},${item.quantity}`);
            textarea.value = lines.join('\n');
            
            // Save to server session
            fetch('/save_temp_wire_ids', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'wire_ids=' + encodeURIComponent(textarea.value)
            }).catch(error => {
                console.warn('Failed to save wire IDs to session:', error);
            });
        }
        
        // Clear all wire IDs
        function clearAllWireIds() {
            if (wireIdList.length === 0) {
                alert('No Wire IDs to clear');
                return;
            }
            
            if (confirm(`Clear all ${wireIdList.length} Wire IDs from the list?`)) {
                wireIdList = [];
                updateTable();
                updateHiddenTextarea(); // This now handles saving to session
            }
        }
        
        // Sort wire IDs alphabetically
        function sortWireIds() {
            wireIdList.sort((a, b) => a.wireId.localeCompare(b.wireId));
            updateTable();
            updateHiddenTextarea();
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners');
            
            // Add button
            const addBtn = document.getElementById('addWireIdBtn');
            if (addBtn) {
                addBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    addWireId();
                });
            }
            
            // Decimal sequence button
            const decimalSeqBtn = document.getElementById('decimalSeqBtn');
            if (decimalSeqBtn) {
                decimalSeqBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    generateDecimalSequence();
                });
            }
            
            // Other buttons
            const clearBtn = document.getElementById('clearAllBtn');
            const sortBtn = document.getElementById('sortBtn');
            
            if (clearBtn) clearBtn.addEventListener('click', clearAllWireIds);
            if (sortBtn) sortBtn.addEventListener('click', sortWireIds);
            
            // Add wire ID on Enter key
            const wireIdInput = document.getElementById('wireIdInput');
            const qtyInput = document.getElementById('qtyInput');
            
            if (wireIdInput) {
                wireIdInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addWireId();
                    }
                });
            }
            
            if (qtyInput) {
                qtyInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addWireId();
                    }
                });
            }
            
            // Modal event listeners
            const modal = document.getElementById('decimalSequenceModal');
            const modalPrefix = document.getElementById('modalPrefix');
            const modalSuffix = document.getElementById('modalSuffix');
            const modalStart = document.getElementById('modalStart');
            const modalStop = document.getElementById('modalStop');
            const modalIncrement = document.getElementById('modalIncrement');
            const modalQtyEach = document.getElementById('modalQtyEach');
            const modalLeadingZeros = document.getElementById('modalLeadingZeros');
            const modalZeroPadding = document.getElementById('modalZeroPadding');
            
            // Update preview when modal inputs change
            const updatePreviewInputs = [modalPrefix, modalSuffix, modalStart, modalStop, modalIncrement, modalQtyEach, modalLeadingZeros, modalZeroPadding];
            updatePreviewInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', updateSequencePreview);
                    input.addEventListener('change', updateSequencePreview);
                }
            });
            
            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeDecimalModal();
                    }
                });
            }
            
            // Modal form submission on Enter
            const modalFormInputs = [modalPrefix, modalSuffix, modalStart, modalStop, modalIncrement, modalQtyEach, modalZeroPadding];
            modalFormInputs.forEach(input => {
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            confirmDecimalSequence();
                        }
                    });
                }
            });
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    closeDecimalModal();
                }
            });
            
            // Import buttons
            const importCSVBtn = document.getElementById('importCSVBtn');
            const importLegacyBtn = document.getElementById('importLegacyBtn');
            
            if (importCSVBtn) {
                importCSVBtn.addEventListener('click', function() {
                    document.getElementById('csvFileInput').click();
                });
            }
            
            if (importLegacyBtn) {
                importLegacyBtn.addEventListener('click', function() {
                    document.getElementById('legacyFileInput').click();
                });
            }
            
            // File input change handlers
            const csvFileInput = document.getElementById('csvFileInput');
            const legacyFileInput = document.getElementById('legacyFileInput');
            
            if (csvFileInput) {
                csvFileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        document.getElementById('importForm').submit();
                    }
                });
            }
            
            if (legacyFileInput) {
                legacyFileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        document.getElementById('importLegacyForm').submit();
                    }
                });
            }
            
            {% if printer_info.available and settings.selected_printer %}
            // Print button
            const printBtn = document.getElementById('printBtn');
            if (printBtn) {
                printBtn.addEventListener('click', function() {
                    if (wireIdList.length === 0) {
                        alert('Please add at least one Wire ID');
                        document.getElementById('wireIdInput').focus();
                        return;
                    }
                    
                    const totalLabels = wireIdList.reduce((sum, item) => sum + item.quantity, 0);
                    
                    if (confirm(`Print ${totalLabels} total labels directly to {{ settings.selected_printer }}?`)) {
                        updateHiddenTextarea();
                        
                        const form = document.getElementById('labelForm');
                        form.action = '/print_labels';
                        console.log('Setting form action to /print_labels'); // Debug
                        form.submit();
                    }
                });
            }
            {% endif %}
            
            // Initialize
            loadExistingWireIds();
        });
        
        // Prevent default form submission if no action is set
        document.getElementById('labelForm').addEventListener('submit', function(e) {
            if (!this.action || this.action.endsWith('/')) {
                e.preventDefault();
                console.log('Form submission prevented - no action set');
                alert('Please use the Print or Export buttons');
                return false;
            }
            console.log('Form submitting to:', this.action);
        });
    </script>
</body>
</html>
